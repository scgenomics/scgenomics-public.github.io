### autogenerated from R -e 'knitr::purl(05-confounders.Rmd)'
### autogenerated from R -e 'knitr::purl(05-confounders.Rmd)'
### autogenerated from R -e 'knitr::purl(05-confounders.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../04-dimred/session.rda")
gc()


## ----cellcycle-umap-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

data(cc.genes)

## add cell cycle phase estimates
srat<- CellCycleScoring(object = srat,
        s.features =   cc.genes$s.genes,
        g2m.features = cc.genes$g2m.genes,
        assay='RNA') # make sure LogNormalized data is used!

## show the UMAP with type and phase information
p_type <-  DimPlot(srat, pt.size=1, group.by='type', cols=type.colors)
p_phase <- DimPlot(srat, pt.size=1, group.by='Phase')

p_type | p_phase



## ----plot-stress----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

data(refdata_cellranger_GRCh38_3.0.0) # this loads genome-specifc data

show(genelists) # show the contents of this list of lists

stress_genes <- genelists$stress

## now use it:
srat <- AddModuleScore(srat, 
                       features=list(stress_genes), 
                       name='stress',
                       assay='RNA') # make sure LogNormalized is used

## check the addition to the meta.data. Note the '1' appended to the
## column name
head(srat@meta.data)

## as with the type colors, we will use a different color scheme that
## may work better. 
## An important other argument that we are passing is  order=TRUE.
## It makes sure that high values are printed 'in front' so they
## are not obscured

title <- labs(title='SCTransform')
p_type <-  DimPlot(srat, pt.size=1, group.by='type', cols=type.colors)
p_stress <- FeaturePlot(srat, pt.size=1, feature='stress1', order=TRUE,
    cols=CFG$gradient.colors) + title

p_type | p_stress



## ----deleting-confounders-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

remove <- unique( c(cc.genes$s.genes, cc.genes$g2m.genes, stress_genes) ) 

srat_clean <- srat # copy so we can compare

VariableFeatures(srat_clean) <- setdiff( VariableFeatures(srat_clean), remove)


## ----redo-dimred----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## redo PCA and UMAP and compare:

srat_clean <- RunPCA(srat_clean)

srat_clean <- RunUMAP(srat_clean, dims=1:CFG$ndims)

## Let's plot old and new, types and cell cycle phase in a four-way plot

old_type <- DimPlot(srat, pt.size=1, group.by='type', 
   cols=type.colors) + labs(title='old')

old_phase <-  DimPlot(srat, pt.size=1, group.by='Phase')

new_type <- DimPlot(srat_clean, pt.size=1, group.by='type', 
   cols=type.colors) +  labs(title='clean')

new_phase <-  DimPlot(srat_clean, pt.size=1, group.by='Phase')

## Create 2x2 plot. Note the use of parentheses to group things
( old_type | old_phase )  /  (new_type | new_phase )

## same, but now with stress (note the reuse of previous plots):
old_stress  <- FeaturePlot(srat, pt.size=1, feature='stress1',
    cols=CFG$gradient.colors, order=TRUE)

new_stress <-  FeaturePlot(srat_clean, pt.size=1, feature='stress1',
    cols=CFG$gradient.colors, order=TRUE)

( old_type | old_stress )  /  (new_type | new_stress )



## ----remove-confounders---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### overwrite the old, un-deconfounded object with the clean one:
srat <- srat_clean 

## clean it up, it's big and unneeded
rm(srat_clean)
gc()



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))


