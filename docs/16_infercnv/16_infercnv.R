
### NOTE: THIS FILE WAS AUTOGENERATED 
### 
###   R -e 'knitr::purl(16_infercnv.Rmd)'
###
### If anything needs changing, do it there and rerun the purl-thing

## ----setup, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## suppressMessages(library(rmarkdown))
## knitr::opts_chunk$set(echo = TRUE,
##   fig.width=9,
##   fig.height=6,
##   cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
##   collapse=TRUE,  # put misc. outputs from one chunk in one block
##   tidy=TRUE, # tidies up the R code
##   tidy.opts=list(arrow=TRUE,
##                  indent=2,
##                  width.cutoff = 60))


## ----loadsession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## source('../libs.R')
## load("../15_singler/session.rda")
## 


## ----infercnv, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
## ## overview of numbers per celltype:
## table(srat@meta.data$type2)
## 
## ## which cells we think we can trust as being healthy:
## ref_types <- c("T", "NK", "B", "Mono")
## 
## ## overview of this:
## maybe_tumor <- !(srat@meta.data$type2 %in% ref_types)
## table( maybe_tumor )
## 
## ## infercnv needs them as an external data file in a specific format,
## ## create that:
## df = data.frame(cell=colnames(srat), type=srat@meta.data$type2)
## 
## 
## celltypes_file =paste0(CFG$output_dir,"/celltypes.txt")
## write.table(df, file=celltypes_file, sep="\t",
##   quote=FALSE, na="", row.names=FALSE, col.names=FALSE)
## 
## ## infercnv also needs to gene coordinates, can find them
## ## in the data directory:
## geneorder_file = paste0(CFG$data_dir, "/geneorder.txt")
## 
## infercnv_obj = infercnv::CreateInfercnvObject(delim="\t",
##       raw_counts_matrix=GetAssayData(srat, assay='RNA', slot='counts'),
##       annotations_file=celltypes_file,
##       gene_order_file=geneorder_file,
##       ref_group_name = ref_types )
## 
## ## free up space before we start:
## gc()
## 
## ## infercnv writes its output to disk. It is a fair amount,
## ## so let's create a separate directory for that and write
## ## it there:
## outdir=paste0(CFG$output_dir, "/infercnv")
## dir.create(outdir)
## 
## ## running takes can take up to 10 min, best start this before the lecture:
## infercnv_obj <- infercnv::run(infercnv_obj,
##                              cutoff=0.3,
##                              out_dir=outdir,
##                              cluster_by_groups=TRUE,
##                              denoise=TRUE,
##                              analysis_mode = "samples",
##                              num_threads = 3,
##                              output_format = "png",
##                              window_length = 101,
##                              save_final_rds = TRUE,
##                              plot_steps=FALSE,
##                              sd_amplifier = 2,
##                              HMM=FALSE)
## ## plot_steps=TRUE leads to weird crash, see github
## 
## ## it took a while so let's save this object:
## file <- paste0(CFG$output_dir, "/infercnv_obj.rds")
## saveRDS(file=file,infercnv_obj)
## 


## ----copyoutput, include=FALSE , eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
## png=list.files(outdir, pattern = "^infercnv.png$", full.names = TRUE)
## ## knitr::include_graphics(png, dpi=NA) ## won't work
## file.copy(png, "figure/", overwrite=TRUE)
## 


## ----savesession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## ## save complete state for next lesson
## ## save complete state for next lesson
## ## save.image("session.rda")
## save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

