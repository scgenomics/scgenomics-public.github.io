### autogenerated from R -e 'knitr::purl(02-filtercells.Rmd)'
### autogenerated from R -e 'knitr::purl(02-filtercells.Rmd)'
### autogenerated from R -e 'knitr::purl(02-filtercells.Rmd)'
### autogenerated from R -e 'knitr::purl(02-filtercells.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../01-loadingdata/session.rda")
gc()



## ----txptcounts-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Seurat makes extensive use of ggplot2. ggplots are objects that can be 
## assigned to variables. They are actually plotted by typing their name.
## The following gives identical results:
##
## VlnPlot(srat, "nCount_RNA", group.by = 'lib') # plotted directly
## v <- VlnPlot(srat, "nCount_RNA", group.by = 'lib') # not yet plotted
## v # now plotted. Advantage is that you can more easily change things

v <- VlnPlot(srat, "nCount_RNA", group.by = 'lib')

## show it:
v 

## add lines, and plot in linear and log scale:
lines <- seq(from = 0, to = 100000, by = 5000)
hlines <- geom_hline(yintercept = lines, col = "grey", linetype=1, lwd=0.1)

v + hlines # plot now has those lines added

## another trick is to change the scale to logarithmic:

v + scale_y_continuous(trans='log2') + hlines



## ----txpt-vs-genes--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## create a scatter graph
f_lin <- FeatureScatter(srat, feature1='nCount_RNA', 
  feature2='nFeature_RNA', pt.size=2)  + 
  geom_hline(yintercept = CFG$max_pctmito, linetype=2) +
  geom_vline(xintercept = c(CFG$min_txpts, CFG$max_txpts),linetype=2)

f_lin

## also show the transcripts in logarithmic scale:

f_log = f_lin +  scale_x_continuous(trans='log2')  + scale_y_continuous(trans='log2') 

f_lin | f_log



## ----mito-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

v <- VlnPlot(srat, "percent_mito", group.by = 'lib')
v



## ----mito-vs-counts-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## actually set the cutoffs (best done at the beginning of your scripts to keep things tidy)
CFG$min_txpts <- 5000
CFG$max_txpts <- 60000
CFG$max_pctmito <- 25

## plot this:

f <- FeatureScatter(srat, feature1='nCount_RNA',
  feature2='percent_mito', pt.size=2) +
  geom_hline(yintercept = CFG$max_pctmito, linetype=2) +
  geom_vline(xintercept = c(CFG$min_txpts, CFG$max_txpts),linetype=2)

f

f + scale_x_continuous(trans='log2') 

## show how many cells will we discard by applying the selection:
dim(srat)
dim(subset(srat, nCount_RNA < CFG$min_txpts))
dim(subset(srat, nCount_RNA > CFG$max_txpts))
dim(subset(srat, percent_mito > CFG$max_pctmito))



## ----subsetting-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## lastly, subset the seurat object and save if needed

srat <- subset(srat,
               subset =
                 nCount_RNA >= CFG$min_txpts
               & nCount_RNA <= CFG$max_txpts
               & percent_mito <= CFG$max_pctmito ) 

dim(srat)



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

