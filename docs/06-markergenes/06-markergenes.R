### autogenerated from R -e 'knitr::purl(06-markergenes.Rmd)'
### autogenerated from R -e 'knitr::purl(06-markergenes.Rmd)'
### autogenerated from R -e 'knitr::purl(06-markergenes.Rmd)'
### autogenerated from R -e 'knitr::purl(06-markergenes.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../05-confounders/session.rda")
gc()



## ----show-muc2------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

p_type <- DimPlot(srat, pt.size=1, group.by='type', cols=type.colors)

## show LGR5 next to type plot
gene="LGR5"
p_lgr5 <- FeaturePlot(srat, pt.size=1, features=gene, 
    cols=CFG$gradient.colors, order=TRUE) + labs(title=gene)
p_type  | p_lgr5

gene="muc2-mneongreen"
p_muc2 <- FeaturePlot(srat, pt.size=1, features=gene, 
   cols=CFG$gradient.colors, order=TRUE) + labs(title=gene)
p_type  | p_muc2



## ----paneth-markers-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Paneth:

paneth_markers <-  c('defa5-ires2-dsred',
  'DEFA6', 
  'PLA2G2A', 
  'PRSS2', 
  'REG3A', 
  'ITLN2')
# note that DEFA5 was removed from the genome so we use the chimeric gene

FeaturePlot(srat, pt.size=1, features=paneth_markers, order=TRUE,
  cols=CFG$gradient.colors)



## ----paneth-score---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## create the modulescore:
srat <- AddModuleScore(srat, 
                       features=list(paneth_markers), 
                       name='Paneth',
                       assay='RNA')

## we can treat the modulescore as if it were a gene. Let's replace the
## defa5_ires2_dsred marker with it, and see if things improve now:

paneth_markers[1] <- 'Paneth1'          # replaces 'defa5-ires2-dsred'

FeaturePlot(srat, pt.size=1, cols=CFG$gradient.colors, order=TRUE,
  features=paneth_markers)



## ----all-markers----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

markers = c(
  SMOC2=               'SMOC2: Stem cells' ,
  MKI67=               'MKI67: Proliferating' ,
  FABP1=               'FABP1: Early enterocytes' ,
  KRT20=               'KRT20: Enterocytes' ,
  HES6=                'HES6: Secretory progen.' ,
  `muc2-mneongreen`=   'MUC2: Goblet' ,
  Paneth1=             'Paneth modulescore' ,
  CHGA=                'CHGA: Enteroendocrine' ,
  AVIL =               'AVIL: Tuft'
)

## create plot showing the expression of all our markers. Assign it to
# an object for later reference
markerplot <- FeaturePlot(srat, pt.size=1, order=TRUE,
   features=names(markers), 
   cols=CFG$gradient.colors)

## override the panel titles for readability
for(i in 1:length(markers))
    markerplot[[i]] <- ( markerplot[[i]] + labs(title = markers[i]) )

## show it:
markerplot



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))


