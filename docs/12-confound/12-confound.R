### autogenerated from R -e 'knitr::purl(12-confound.Rmd)'
### autogenerated from R -e 'knitr::purl(12-confound.Rmd)'
### autogenerated from R -e 'knitr::purl(12-confound.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../11-normdimred/session.rda")
data(refdata_cellranger_GRCh38_3.0.0)


## ----deconfounding--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Scor <- metadataCorrelations(srat, 'S.Score')

G2Mcor <- metadataCorrelations(srat, 'G2M.Score')

additional <- derivedCellcycleGenes(Scor=Scor,
                                    Sgenes=genelists$s.genes,
                                    G2Mcor=G2Mcor,
                                    G2Mgenes=genelists$g2m.genes,
                                    plot=TRUE)

## see what's in the lists:
show(additional)

## also get the other deconfounders:
stress_genes <- genelists$stress # OR: SCutils::lookup.stressgenes()
hb_genes <- genelists$hemo # as before

## combine these sets (also including stress_genes and hemoglobin genes)
remove <- unique(c(cc.genes$s.genes, cc.genes$g2m.genes, 
  additional$S.derived, additional$G2M.derived, 
  stress_genes, hb_genes))

## check how many we will loose now:
length(intersect(VariableFeatures(srat), remove))



## ----remove-vargenes------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## do the removal, for both the 'RNA' (i.e. LogNorm) and 'SCT' assays:
VariableFeatures(srat, assay='RNA') <-
   setdiff( VariableFeatures(srat, assay='RNA'), remove)

VariableFeatures(srat, assay='SCT') <- 
   setdiff( VariableFeatures(srat, assay='SCT'), remove)



## ----rerun-dimred---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
srat <- RunPCA(srat, verbose = TRUE, npcs = 50)

srat <- RunUMAP(srat, dims=1:CFG$ndims )

## show the results:
p_plate <- DimPlot(srat, reduction = "umap", pt.size=0.5,
  group.by='plate_id')

p_patient <- DimPlot(srat, reduction = "umap", pt.size=0.5,
  group.by='patient')

p_type <- DimPlot(srat, reduction = "umap",pt.size=0.5,
  group.by='type')

p_phase <- DimPlot(srat, reduction = "umap", pt.size=0.5,
  group.by='Phase')

## use patchwork again to get a 2 x 2 plot
( p_plate | p_patient ) / ( p_type | p_phase )

## and also the continuous variables:
FeaturePlot(srat, pt.size=0.5, 
  feature=c('nCount_RNA', 'percent_mito',
  'pct_hemo', 'stress1'), order=TRUE,
  cols=CFG$gradient.colors)



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

