### autogenerated from R -e 'knitr::purl(07-clustering.Rmd)'
### autogenerated from R -e 'knitr::purl(07-clustering.Rmd)'
### autogenerated from R -e 'knitr::purl(07-clustering.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../06-markergenes/session.rda")
gc()



## ----clustering-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

srat <- FindNeighbors(srat,  dims = 1:CFG$ndims)
                              
srat <- FindClusters(srat, resolution = 0.4,
                              algorithm = 1)

srat <- FindClusters(srat, resolution = 0.8,
                              algorithm = 1)

srat <- FindClusters(srat, resolution = 1.2,
                              algorithm = 1)

## show the columns that were added to the metadata:
head(srat@meta.data)

## or
columns <- grep("SCT_snn_res", names(srat@meta.data), value=TRUE)
head(srat@meta.data[ , columns])

## show numbers of cells per cluster (top row shows the cluster ids)
for (col in columns) {
    cat("\n====\n", col, ":")
    print(table(srat@meta.data[[col]]))
}



## ----plot-clusters--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## assign plot to a variable for convenience:
p_bytype <- DimPlot(srat, pt.size=1, group.by='type', cols=type.colors) 

## for easy plotting, assign the different resolution plots to a list() 
p_clusbyreso <- list()

for (reso in c("0.4",  "0.8", "1.2" )) { 
 
 column <- paste0("SCT_snn_res.", reso)
 clusters <-sort(unique(srat@meta.data[[column]]))
 
 ## switching color scheme to make it look different:
 clus.colors <- Polychrome::alphabet.colors(length(clusters))
 names(clus.colors) <- as.character(clusters)

 p <- DimPlot(srat, pt.size=1, group.by=column, cols=clus.colors ) +  labs(title=reso)
 p_clusbyreso[[reso]]<- p
}

## plot them side by side:

p_bytype | p_clusbyreso[[ "0.4" ]] 

p_bytype | p_clusbyreso[[ "0.8" ]] 
 
p_bytype | p_clusbyreso[[ "1.2" ]] 



## ----rm_p_clusbyreso, include=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

rm(p_clusbyreso)
gc()



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

