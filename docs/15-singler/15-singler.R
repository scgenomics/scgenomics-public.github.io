### autogenerated from R -e 'knitr::purl(15-singler.Rmd)'
### autogenerated from R -e 'knitr::purl(15-singler.Rmd)'
### autogenerated from R -e 'knitr::purl(15-singler.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../14-enrich/session.rda")
data(refdata_cellranger_GRCh38_3.0.0)


## ----pretend-continuity, include=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## make it look like we had the p_plate etc. plots from previous session.
## Including the plots rda file is too big so just remake them but don't show them

clus.column <- paste0("SCT_snn_res.", 0.8) ##

Idents(srat) <- clus.column
  
clusters <- sort(unique(srat@meta.data[[clus.column]]))
## switching color scheme to make it look different:
cluster.colors <- Polychrome::alphabet.colors(length(clusters))
names(cluster.colors) <- as.character(clusters)

p_clus <- DimPlot(srat, reduction = "umap", pt.size=0.5, 
  group.by=clus.column, cols=cluster.colors)

p_plate <- DimPlot(srat, reduction = "umap", pt.size=0.5,
  group.by='plate_id')

p_patient <- DimPlot(srat, reduction = "umap", pt.size=0.5,
  group.by='patient')

p_type <- DimPlot(srat, reduction = "umap",pt.size=0.5,
  group.by='type')

## NOT SHOWING IT, this is just so we have it available later on



## ----run-singler----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## (down)load the reference data:
hpca <- HumanPrimaryCellAtlasData()
## file <- paste0(CFG$data_dir, '/hpca.rds') # cached verssion for speed
## hpca <- readRDS(file=file)

## check how many (and/or which) types:
length( unique(hpca$label.main) )
length( unique(hpca$label.fine) )

## following takes 2 min or so:
singler_hpca <- SingleR(test = GetAssayData(srat, assay = "RNA", slot = "data"),
   ref = hpca, labels = hpca$label.main)

## plot the heatmap
SingleR::plotScoreHeatmap(singler_hpca,
                          show.labels = TRUE, max.labels=100,
                          show.pruned = FALSE,
                          order.by="clusters",
                          clusters = srat@meta.data[[clus.column]], 
                          annotation_colors = list(Clusters=cluster.colors)
                          )


## ----singler-overview-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

srat@meta.data$singler <- singler_hpca$first.labels

cbind(table(singler_hpca$first.labels)) # cbind to make a nice table

## Plot this:

typenames  <- unique( srat@meta.data$singler  )
singler.colors <- Polychrome::alphabet.colors(length(typenames))
names(singler.colors) <- typenames

p_singler <- DimPlot(srat, reduction = "umap", pt.size=0.5, 
  group.by='singler', cols=singler.colors)

## show it:

p_singler



## ----singler-type-assignment----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## show previous plot to get our bearings:
( p_plate | p_patient ) / ( p_type | p_clus )

## do the asssignment, abbreviating them a bit for convenience 
## and, for the 'suspect' ones, also include the cluster of origin
  
  type2 <- rep("unknown", nrow(srat@meta.data))
  names(type2) <- rownames(srat@meta.data)
  
  type2[ WhichCells(srat, idents = "0"  )  ] <- 'T'
  type2[ WhichCells(srat, idents = "1"  )  ] <- 'ESC-1'
  type2[ WhichCells(srat, idents = "2"  )  ] <- 'ESC-2'
  type2[ WhichCells(srat, idents = "3"  )  ] <- 'ESC-3'
  type2[ WhichCells(srat, idents = "4"  )  ] <- 'NK'
  type2[ WhichCells(srat, idents = "5"  )  ] <- 'ESC-5'
  type2[ WhichCells(srat, idents = "6"  )  ] <- 'Mono'
  type2[ WhichCells(srat, idents = "7"  )  ] <- 'ESC-7'
  type2[ WhichCells(srat, idents = "8"  )  ] <- 'ESC-8'
  type2[ WhichCells(srat, idents = "9"  )  ] <- 'B'
  type2[ WhichCells(srat, idents = "10" )  ] <- 'B'
  type2[ WhichCells(srat, idents = "11" )  ] <- 'Chondro'

srat <- AddMetaData(srat, col.name='type2', metadata=type2)

typenames <- unique(type2)
type2.colors <- Polychrome::alphabet.colors(length(typenames))
names(type2.colors) <- typenames

p_type2 <- DimPlot(srat, reduction = "umap", pt.size=0.5, 
  group.by='type2', cols=type2.colors)

## show the final result, this time together with the other characteristics
## just because we can :-)
( p_patient | p_clus ) / ( p_type | p_type2 )



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

