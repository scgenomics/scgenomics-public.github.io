
### autogenerated from R -e 'knitr::purl(15_singler.Rmd)'
## ----setup, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## suppressMessages(library(rmarkdown))
## knitr::opts_chunk$set(echo = TRUE,
##   fig.width=9,
##   fig.height=6,
##   cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
##   collapse=TRUE,  # put misc. outputs from one chunk in one block
##   tidy=TRUE, # tidies up the R code
##   tidy.opts=list(arrow=TRUE,
##                  indent=2,
##                  width.cutoff = 60))


## ----loadsession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## source('../libs.R')
## load("../14_enrich/session.rda")
## 


## ----pretend-continuity, include=FALSE, eval=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
##   clus.column <- paste0("SCT_snn_res.", 0.8) ## risky to hard code this ..
##   Idents(srat) <- clus.column
## 
##   clusters <- sort(unique(srat@meta.data[[clus.column]]))
##   ## switching color scheme to make it look different:
##   cluster.colors <- Polychrome::alphabet.colors(length(clusters))
##   names(cluster.colors) <- as.character(clusters)
## 
## ##@ and show result with the other umaps to get your bearings:
##   p_clus <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##      group.by=clus.column, cols=cluster.colors)
## 
## p_plate <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='plate_id')
## 
## p_plate <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='plate_id')
## p_patient <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='patient')
## p_type <- DimPlot(srat, reduction = "umap",pt.size=0.5,
##   group.by='type')
## p_phase <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='Phase')
## 


## ----singler, eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
## ## load the reference data:
## ## hpca <- HumanPrimaryCellAtlasData()
## file <- paste0(CFG$data_dir, '/hpca.rds') # cached verssion for speed
## hpca <- readRDS(file=file)
## 
## ## check how many (and/or which) types:
## length( unique(hpca$label.main) )
## length( unique(hpca$label.fine) )
## 
## ## following takes 2 min or so:
## singler_hpca <- SingleR(test = GetAssayData(srat, assay = "RNA", slot = "data"),
##    ref = hpca, labels = hpca$label.main)
## 
## SingleR::plotScoreHeatmap(singler_hpca,
##                           show.labels = TRUE, max.labels=100,
##                           show.pruned = FALSE,
##                           order.by="clusters",
##                           clusters = srat@meta.data[[clus.column]],
##                           annotation_colors = list(Clusters=cluster.colors)
##                           )
## 
## ## show previous plot to get our bearings:
## ( p_plate | p_patient ) / ( p_type | p_clus )
## 
## ## do the  asssignment:
##   type2 <- rep("unknown", nrow(srat@meta.data))
##   names(type2) <- rownames(srat@meta.data)
## 
##   type2[ WhichCells(srat, idents = 0  )  ] <- 'ESC-0'
##   type2[ WhichCells(srat, idents = 1  )  ] <- 'T'
##   type2[ WhichCells(srat, idents = 2  )  ] <- 'ESC-2'
##   type2[ WhichCells(srat, idents = 3  )  ] <- 'ESC-3'
##   type2[ WhichCells(srat, idents = 4  )  ] <- 'NK'
##   type2[ WhichCells(srat, idents = 5  )  ] <- 'Mono'
##   type2[ WhichCells(srat, idents = 6  )  ] <- 'ESC-6'
##   type2[ WhichCells(srat, idents = 7  )  ] <- 'ESC-7'
##   type2[ WhichCells(srat, idents = 8  )  ] <- 'B'
##   type2[ WhichCells(srat, idents = 9  )  ] <- 'B'
##   type2[ WhichCells(srat, idents = 10  )  ] <- 'Mesen'
## 
## srat <- AddMetaData(srat, col.name='type2', metadata=type2)
## 
## typenames = unique(type2)
## ### type2.colors <- c(T="red", ESC="black", B="blue", NK="DarkGreen", Mesen="brown", Mono="orange")
## type2.colors <- Polychrome::alphabet.colors(length(typenames))
## names(type2.colors) <- typenames
## 
## p_type2 <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='type2', cols=type2.colors)
## 
## ## show the final result:
## ( p_patient | p_clus ) / ( p_type | p_type2 )
## 


## ----savesession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## ## save complete state for next lesson
## ## save complete state for next lesson
## ## save.image("session.rda")
## save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

