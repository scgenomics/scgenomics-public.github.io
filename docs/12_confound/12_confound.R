
### NOTE: THIS FILE WAS AUTOGENERATED 
### 
###   R -e 'knitr::purl(12_confound.Rmd)'
###
### If anything needs changing, do it there and rerun the purl-thing


### NOTE: THIS FILE WAS AUTOGENERATED 
### 
###   R -e 'knitr::purl(12_confound.Rmd)'
###
### If anything needs changing, do it there and rerun the purl-thing

## ----setup, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## suppressMessages(library(rmarkdown))
## knitr::opts_chunk$set(echo = TRUE,
##   fig.width=9,
##   fig.height=6,
##   cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
##   collapse=TRUE,  # put misc. outputs from one chunk in one block
##   tidy=TRUE, # tidies up the R code
##   tidy.opts=list(arrow=TRUE,
##                  indent=2,
##                  width.cutoff = 60))


## ----loadsession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## source('../libs.R')
## load("../11_normdimred/session.rda")


## ----deconfounding, eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
## data(cc.genes)
## 
## file <- paste0(CFG$data_dir, "/stress_genes.rds")
## stress_genes <- readRDS(file)
## 
## file <- paste0(CFG$data_dir, "/hemo_genes.rds")
## hemo_genes <- readRDS(file)
## 
## ## get the external code:
## source(paste0(CFG$data_dir, "/correlators.R"))
## 
## ## this function plots an overview but also returns a list
## additional <- derivedCellcycleGenes(srat)
## 
## ## see what's in the list:
## show(additional)
## 
## ## combine these sets (also including stress_genes and hemoglobin genes)
## remove <- unique(c(cc.genes$s.genes, cc.genes$g2m.genes,
##   additional$S.derived, additional$G2M.derived,
##   stress_genes, hemo_genes))
## 
## ## check how many:
## length(intersect(VariableFeatures(srat) , remove))
## 


## ----remove-rerun-dimred, eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## 
## ## do the removal:
## VariableFeatures(srat) <- setdiff( VariableFeatures(srat), remove)
## 
## ## how much now:
## length(VariableFeatures(srat))
## 
## ## IMPORTANT: the VariableFeature are kept per assay,
## ## but we only removed them for the DefaultAssay, which
## ## is 'SCT'. We also must remove them for the RNA assay
## DefaultAssay(srat) <- 'RNA'
## VariableFeatures(srat) <- setdiff( VariableFeatures(srat), remove)
## DefaultAssay(srat) <- 'SCT'
## 
## srat <- RunPCA(srat, verbose = TRUE, npcs = 50)
## 
## srat <- RunUMAP(srat, dims=1:CFG$ndims )
## 
## ## show the results:
## p_plate <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='plate_id')
## 
## p_patient <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='patient')
## 
## p_type <- DimPlot(srat, reduction = "umap",pt.size=0.5,
##   group.by='type')
## 
## p_phase <- DimPlot(srat, reduction = "umap", pt.size=0.5,
##   group.by='Phase')
## 
## ( p_plate | p_patient ) / ( p_type | p_phase )
## 
## ## and also the continuous variables:
## FeaturePlot(srat, pt.size=0.5,
##   feature=c('nCount_RNA', 'percent_mito',
##   'pct_hemo', 'stress1'), order=TRUE,
##   cols=CFG$gradient.colors)
## 


## ----savesession, include=FALSE, eval=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## ## save complete state for next lesson
## ## save complete state for next lesson
## ## save.image("session.rda")
## save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

