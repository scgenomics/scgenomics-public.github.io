### autogenerated from R -e 'knitr::purl(09-loadfilter.Rmd)'
### autogenerated from R -e 'knitr::purl(09-loadfilter.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----libraries, warning=FALSE, message=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# libraries
library(Seurat)
library(Matrix)
library(dplyr)
library(ggplot2)
library(patchwork)
library(clusterProfiler) # enrichment analysis
library(org.Hs.eg.db) # gene annotation databases
library(SCutils) # our R package with various convenience data and functions.
library(SingleR) # automatic celltype identification
library(infercnv) # finding CNV's in scRNAseq data
library(clustree) # visualize how clusters split when increasing resolution
library(ggraph) # needed for clustree


## ----configvars-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

data(refdata_cellranger_GRCh38_3.0.0) # reference data

CFG <- list() # global

CFG$data_dir <- "/opt/course/day2" # where to ready data from
CFG$output_dir <- "."              # where to write data to

CFG$random_seed <- 2033



## ----overrule-dirs, include=FALSE-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## when developing, data_dir and output_dir may be different; overrule them here:
if ( Sys.getenv("dev") == "TRUE" ) {
  CFG$data_dir <-  "~/data/course/day2"
  CFG$output_dir <- "~/tmp/day2"
}


## ----readdata-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## Load it:
file <- paste0(CFG$data_dir,"/srat-raw.rds")
srat <- readRDS(file)



## ----filtercells----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## show the distribution of transcipts, by plate:
v <- VlnPlot(srat, "nCount_RNA", group.by = 'plate_id')

v

## same, but using a logarithmic scale:
v + scale_y_continuous(trans='log2')

## following might be reasonable:

CFG$min_txpts = 1000
CFG$max_txpts = Inf  # meaning Infinity



## ----mitochondria---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

v <- VlnPlot(srat, "percent_mito", group.by = 'plate_id')

v

CFG$max_pctmito = 60



## ----finalselect----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## show our choices:
FeatureScatter(srat, feature1='nCount_RNA', 
  feature2='percent_mito', pt.size=2)  + 
  geom_hline(yintercept = CFG$max_pctmito, linetype=2) +
  geom_vline(xintercept = c(CFG$min_txpts, CFG$max_txpts),linetype=2) + 
  scale_x_continuous(trans='log2')

## how much do we have currently:
dim(srat)

## what will we lose:
dim(subset(srat, nCount_RNA < CFG$min_txpts))
dim(subset(srat, percent_mito > CFG$max_pctmito))

## and do the subsetting
srat <- subset(srat,
               subset =
                 nCount_RNA >= CFG$min_txpts
               & percent_mito <= CFG$max_pctmito ) 

## how much do we have now:
dim(srat)

# maybe save
file  <- paste0(CFG$output_dir,'/srat-cellsfiltered.rds')
saveRDS(file=file, srat)



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))

