### autogenerated from R -e 'knitr::purl(04-dimred.Rmd)'
### autogenerated from R -e 'knitr::purl(04-dimred.Rmd)'
### autogenerated from R -e 'knitr::purl(04-dimred.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../03-normalize/session.rda")
gc()



## ----runpca---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  DefaultAssay(srat) # just check that it has 'SCT'
  srat <- RunPCA(srat, npcs=50)
  

  DimPlot(srat, reduction = "pca", cols=type.colors,
    pt.size=1, group.by='type')
    


## ----screeplot------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## The ggplot's patchwork has a nifty way to compose multipanel graphs
## by using '|' for putting things next to each other, and '/' to 
## stack things vertically (think of an arithmetic division line)

ElbowPlot(srat, ndims=50, reduction="pca")



## ----dimheatmap-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

DimHeatmap(srat, dims = 1:12, cells= 100)



## ----do-umap--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## CFG$ndims <- 25
## CFG$random_seed <- 2033

srat <- RunUMAP(srat, dims=1:CFG$ndims, seed.use = CFG$random_seed ) # play with the seed a bit

DimPlot(srat, reduction = "umap", pt.size=1,  group.by='type', cols=type.colors)

## after this we will leave out the 'reduction = "umap"' for brevity,
## DimPlot first searches for umap, then tsne, then pca



## ----umap-nngbs-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### play around with the n.neighbors parameter:

srat_ngbs5 <- RunUMAP(srat, dims=1:CFG$ndims, n.neighbors=5)

ngbs30 <- DimPlot(srat, pt.size=1, group.by='type', cols=type.colors )+
  labs(title='n.ngbs=30') 

ngbs5 <- DimPlot(srat_ngbs5, pt.size=1, group.by='type', cols=type.colors) +
  labs(title='n.ngbs=5')

ngbs30 | ngbs5

## we choose 30, so we should delete srat_ngbs5 to save space
rm(srat_ngbs5)
gc()



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))


