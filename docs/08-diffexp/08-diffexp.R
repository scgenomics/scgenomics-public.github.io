### autogenerated from R -e 'knitr::purl(08-diffexp.Rmd)'
### autogenerated from R -e 'knitr::purl(08-diffexp.Rmd)'
### autogenerated from R -e 'knitr::purl(08-diffexp.Rmd)'
## ----setup, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
suppressMessages(library(rmarkdown))
knitr::opts_chunk$set(echo = TRUE,
  fig.width=9,
  fig.height=6,
  cache=FALSE, # only use TRUE if you're really sure. Also check xfun::cache_rds
  collapse=TRUE,  # put misc. outputs from one chunk in one block
  tidy=TRUE, # tidies up the R code
  tidy.opts=list(arrow=TRUE, 
                 indent=2,
                 width.cutoff = 60))


## ----loadsession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source('../libs.R')
load("../07-clustering/session.rda")
gc()



## ----findmarkers----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

column <- 'SCT_snn_res.1.2'
Idents(srat) <-  column

clusters <-sort(unique(srat@meta.data[[column]]))
cluster.colors <- Polychrome::alphabet.colors(length(clusters))
names(cluster.colors)=as.character(clusters)

de_genes <- FindAllMarkers(srat, assay='RNA', 
                           only.pos = TRUE,
                           min.pct = 0.1,
                           logfc.threshold = log(1.5) )

## save just in case
file <- paste0(CFG$output_dir, "/intestorgs_de_genes.txt")
write.table(de_genes, file=file, sep = "\t", 
    quote = FALSE, row.names = T, col.names = NA, na = "")

de_genes %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC) -> top5

DoHeatmap(subset(srat, downsample = 50),
          features = top5$gene,
          group.colors=cluster.colors,
          assay='RNA',
          slot='scale.data')  + theme(axis.text.y=element_text(size=6))

## Another way of showing this:
DotPlot(srat, features=unique(top5$gene), cols=c('blue', 'red'), 
   col.min=0, col.max=1, dot.scale=3) + 
   coord_flip()  # genes are rows, columns are clusters

## If the labels are unreadable, 'add' the following 
## to the plot function call, to make the labels smaller:
## + theme(axis.text.y=element_text(size=6))

## Note: the 'markerplot' object from marker gene practical 
## has an overview of the markers



## ----again-cellcylce------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

p_bytype <- DimPlot(srat,
  pt.size = 1, group.by = "type", cols = type.colors) + labs(title = "types")

p_byphase <-  DimPlot(srat, pt.size = 1, group.by = "Phase")

column <- "SCT_snn_res.1.2"
clusters <-sort(unique(srat@meta.data[[column]]))
cluster.colors <- Polychrome::alphabet.colors(length(clusters))
names(cluster.colors) <- as.character(clusters)

p_bycluster <-  DimPlot(srat, pt.size=1, group.by=column, cols=cluster.colors ) +  labs(title=column)

##@ show side by side

p_bytype | p_byphase  | p_bycluster 



## ----assignment-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## set up empty vector with the names, then fill them.
types2 <- rep("unknown", nrow(srat@meta.data))
names(types2) <- rownames(srat@meta.data)

## do the assignment
types2 [ WhichCells(srat, idents=1) ] <- 'ISC'
types2 [ WhichCells(srat, idents=c(4,6,8,9) ) ] <- 'TA'
types2 [ WhichCells(srat, idents=c(0,5) ) ] <- 'early EC'
types2 [ WhichCells(srat, idents=3) ] <- 'EC'
types2 [ WhichCells(srat, idents=7) ] <- 'secretory prog.'
## override those with high AVIL expression:
types2 [ WhichCells(srat, idents=7, expression = { AVIL > 2 } ) ] <- 'Tuft'
types2 [ WhichCells(srat, idents=10) ] <- 'EEC'
types2 [ WhichCells(srat, idents=2) ] <- 'Goblet'
## override those with high Paneth expression
types2 [ WhichCells(srat, idents=2, expression =  { Paneth1 > 1 }) ] <- 'Paneth'

srat <- AddMetaData(srat, col.name='type2', metadata=types2)

## show it:

type2.colors <- Polychrome::dark.colors( length(unique(types2)))
names(type2.colors)<-unique(types2)

p_bytype2 <- DimPlot(srat,
  pt.size = 1, group.by = "type2", cols = type2.colors) + labs(title = "type2")

( p_bytype | p_byphase ) / (  p_bycluster  | p_bytype2 )



## ----savesession, include=FALSE-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
## save complete state for next lesson
## save.image("session.rda")
if(Sys.getenv("nodump")!="TRUE")
    save(file="session.rda", list=c("srat", ls(pat="col|CFG")))


